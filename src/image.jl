struct Image{V<:AbstractVector{<:Real}}
    Rb :: V
    Zb :: V
    Lb :: V
    dψdn_R :: V
    _Vb::Vector{V}
end

function Image(Rb, Zb, Lb, dψdn_R)
    Vb = [zero(Lb) for _ in 1:Threads.nthreads()]
    Image(Rb, Zb, Lb, dψdn_R, Vb)
end

function cumlength(R::T, Z::T) where {T<:AbstractVector{Float64}}
    # Length along boundary
    L = Array{Float64,1}(undef, length(R))
    @inbounds L[1] = 0
    for i in eachindex(R)[2:end]
        @inbounds L[i] = L[i-1] + sqrt((R[i] - R[i-1])^2 + (Z[i] - Z[i-1])^2)
    end
    return L
end

function Image(shot::TEQUILA.Shot)
    bnd = @views MillerExtendedHarmonic.MXH(shot.surfaces[:, end])
    return Image(shot, bnd)
end
function Image(shot::TEQUILA.Shot, bnd::MillerExtendedHarmonic.MXH; Nb::Integer=100 * length(bnd.c))
    image = Image(shot, bnd(Nb; adaptive=false)...)
    #Rb = [5.516518229375, 5.46454587625, 5.455505486331595, 5.412573523125, 5.36060117, 5.3214693946193075, 5.308628816875, 5.25665646375, 5.204684110625, 5.1879530840531, 5.1527117575, 5.100739404375, 5.06611050320659, 5.04876705125, 5.027812282049402, 4.998193430048789, 4.996794698125, 4.975475705423849, 4.94700318254608, 4.9448223449999995, 4.920767610956423, 4.892849991875, 4.892312086811183, 4.8656371768573825, 4.84087763875, 4.8380577477547275, 4.811042737779051, 4.788905285625, 4.783766042357797, 4.75658702558799, 4.7369329325, 4.729427863719391, 4.702205651454157, 4.684960579375, 4.675124657521775, 4.647939888175974, 4.63298822625, 4.620916142573853, 4.593787557641147, 4.581015873125, 4.566823703863429, 4.5400809245250535, 4.52904352, 4.514118241260674, 4.488943201592175, 4.477071166875, 4.464731486832423, 4.441421069090094, 4.42509881375, 4.419273068738162, 4.397758588343713, 4.377351204546897, 4.3731264606249995, 4.358133437883104, 4.339974725054515, 4.3228451777525185, 4.3211541075, 4.3068233905312, 4.291881069413982, 4.278032074328069, 4.2691817543749995, 4.265414756635431, 4.25337621107164, 4.2426023547782235, 4.232852172596148, 4.22413576929618, 4.21720940125, 4.216536560737677, 4.209797033598249, 4.203775243061499, 4.198861814766576, 4.1949567861891115, 4.191951387427139, 4.189846796126575, 4.188652830227217, 4.188370954892677, 4.189002687022832, 4.190551692879514, 4.193018541647064, 4.196396669973923, 4.200726660332294, 4.206171868467853, 4.212688907462588, 4.21720940125, 4.219805437194038, 4.228189720658323, 4.2377997869164235, 4.248586693195916, 4.260701544851447, 4.2691817543749995, 4.273835705004445, 4.288593468297449, 4.304844966962428, 4.3211541075, 4.322625583882817, 4.342470494345895, 4.364248178610648, 4.3731264606249995, 4.387915326270374, 4.414288370937568, 4.42509881375, 4.443246590479736, 4.475478858414064, 4.477071166875, 4.511440503905181, 4.52904352, 4.5519140983691315, 4.581015873125, 4.5979677346890435, 4.63298822625, 4.651266948237363, 4.684960579375, 4.714463329636908, 4.7369329325, 4.788905285625, 4.791948130156458, 4.84087763875, 4.892849991875, 4.8947977749380716, 4.9448223449999995, 4.996794698125, 5.04876705125, 5.058560609092191, 5.100739404375, 5.1527117575, 5.204684110625, 5.25665646375, 5.308628816875, 5.36060117, 5.412573523125, 5.46454587625, 5.516518229375, 5.5684905825, 5.6204629356249995, 5.67243528875, 5.69660285055611, 5.724407641875, 5.776379995, 5.828352348125, 5.88032470125, 5.932297054375, 5.9682046206998765, 5.9842694075, 6.036241760625, 6.08821411375, 6.140186466875, 6.174305508628301, 6.1921588199999995, 6.244131173125, 6.29610352625, 6.348075879375, 6.350811475850057, 6.4000482325, 6.452020585625, 6.50399293875, 6.508021833660775, 6.555965291875, 6.607937645, 6.651321087484131, 6.659909998125, 6.71188235125, 6.763854704375, 6.782335116760737, 6.8158270575, 6.8677994106249995, 6.903630135772718, 6.91977176375, 6.971744116875, 7.015952475202327, 7.02371647, 7.075688823125, 7.120099990198835, 7.12766117625, 7.179633529375, 7.216740554991675, 7.2316058825, 7.283578235625, 7.306643586729827, 7.33555058875, 7.387522941875, 7.3900370824068355, 7.439495295, 7.467641028535302, 7.491467648125, 7.539772250962045, 7.54344000125, 7.595412354375, 7.60635423076521, 7.6473847075, 7.6682303603692015, 7.699357060625, 7.725396499869557, 7.75132941375, 7.77827079837321, 7.803301766875, 7.827081454747488, 7.85527412, 7.872075735977771, 7.907246473125, 7.913245324138486, 7.951284473775436, 7.95921882625, 7.985875291591209, 8.011191179375, 8.017412676518893, 8.046147223268617, 8.0631635325, 8.072085820078296, 8.095266480064637, 8.115135885625, 8.11593846428115, 8.13415284690577, 8.149919059510983, 8.163357439937444, 8.16710823875, 8.17440458725784, 8.183276705776974, 8.189747355449848, 8.193917491581935, 8.19575674319752, 8.195205349361839, 8.192202428109146, 8.186692578582045, 8.178574087613791, 8.167633933147524, 8.16710823875, 8.153855277048047, 8.137099443669864, 8.117127840644969, 8.115135885625, 8.093966792315348, 8.067195363288702, 8.0631635325, 8.036930570675148, 8.011191179375, 8.002770117806698, 7.964308614047281, 7.95921882625, 7.921946726451824, 7.907246473125, 7.874902710672011, 7.85527412, 7.82318724104408, 7.803301766875, 7.76661124423807, 7.75132941375, 7.7047061014269085, 7.699357060625, 7.6473847075, 7.638037051980289, 7.595412354375, 7.565741445854652, 7.54344000125, 7.491467648125, 7.488017749311499, 7.439495295, 7.404455960860213, 7.387522941875, 7.33555058875, 7.315252574937743, 7.283578235625, 7.2316058825, 7.220412924069044, 7.179633529375, 7.12766117625, 7.119858852733663, 7.075688823125, 7.02371647, 7.013577111941794, 6.971744116875, 6.91977176375, 6.901752274894748, 6.8677994106249995, 6.8158270575, 6.78460728409055, 6.763854704375, 6.71188235125, 6.662431465262301, 6.659909998125, 6.607937645, 6.555965291875, 6.5355126899388525, 6.50399293875, 6.452020585625, 6.4039724596959795, 6.4000482325, 6.348075879375, 6.29610352625, 6.269697043641847, 6.244131173125, 6.1921588199999995, 6.140186466875, 6.135160047609997, 6.08821411375, 6.036241760625, 5.999376931355773, 5.9842694075, 5.932297054375, 5.88032470125, 5.86423369062025, 5.828352348125, 5.776379995, 5.728570221125623, 5.724407641875, 5.67243528875, 5.6204629356249995, 5.591979186257611, 5.5684905825, 5.516518229375]
    #Zb = [-3.0260478769645816, -3.0625544122392543, -3.0678679876625, -3.098116444491172, -3.137015497559487, -3.163341277428125, -3.17408010549504, -3.214296404134054, -3.253033583247061, -3.25881456719375, -3.2795726381317407, -3.2915797044197053, -3.25881456719375, -3.242470178073106, -3.163341277428125, -3.0678679876625, -3.0643620069827673, -2.972394697896875, -2.87692140813125, -2.870812969660079, -2.781448118365625, -2.688210967268593, -2.6859748286, -2.590501538834375, -2.5062141050967592, -2.49502824906875, -2.399554959303125, -2.323946013211204, -2.3040816695375, -2.208608379771875, -2.1416113082155195, -2.11313509000625, -2.0176618002406252, -1.9589262551611946, -1.922188510475, -1.826715220709375, -1.7757355105001111, -1.7312419309437501, -1.6357686411781251, -1.5919971810662181, -1.5402953514125, -1.444822061646875, -1.4055159470238694, -1.34934877188125, -1.253875482115625, -1.20818154926288, -1.15840219235, -1.0629289025843751, -0.9932571763096197, -0.9674556128187501, -0.8719823230531251, -0.7765090332875001, -0.7560478790060529, -0.6810357435218751, -0.58556245375625, -0.4900891639906251, -0.4802238225136195, -0.3946158742250001, -0.29914258445937514, -0.2036692946937501, -0.1369108411377239, -0.10819600492812512, -0.01272271516250012, 0.08275057460312488, 0.17822386436874987, 0.2736971541343749, 0.36072228728455297, 0.36917044389999987, 0.46464373366562484, 0.5601170234312498, 0.6555903131968749, 0.7510636029624999, 0.8465368927281248, 0.9420101824937499, 1.0374834722593749, 1.1329567620249998, 1.2284300517906248, 1.3239033415562498, 1.4193766313218747, 1.5148499210875, 1.610323210853125, 1.7057965006187499, 1.8012697903843748, 1.8625355871096752, 1.8967430801499998, 1.9922163699156248, 2.0876896596812498, 2.1831629494468747, 2.2786362392124997, 2.341292335281921, 2.3741095289781247, 2.4695828187437496, 2.5650561085093746, 2.6530441513027316, 2.660529398275, 2.756002688040625, 2.85147597780625, 2.8888100041460114, 2.946949267571875, 3.0424225573375, 3.0797642255755524, 3.137895847103125, 3.23336913686875, 3.2379412813356447, 3.328842426634375, 3.372511954959342, 3.4243157163999998, 3.4867569596828147, 3.5197890061656247, 3.584731107632163, 3.6152622959312497, 3.6689225384145647, 3.7107355856968747, 3.7411114467838398, 3.8030062847179082, 3.8062088754624996, 3.8556737393661153, 3.9002309307368286, 3.9016821652281246, 3.9374479203878567, 3.968427657993943, 3.993352120655502, 3.9971554549937496, 4.012847292899103, 4.028187538531353, 4.03920624386823, 4.046448079250198, 4.050266830872802, 4.05097068831434, 4.048850615086185, 4.044160399228187, 4.037148858571135, 4.028077354755643, 4.016988029960241, 4.003857357708701, 3.9971554549937496, 3.989658702916636, 3.9735830938090086, 3.955924298321968, 3.9368770556175106, 3.916580576660215, 3.9016821652281246, 3.8951610970766737, 3.8723841963427947, 3.848446702172943, 3.823458285318573, 3.8062088754624996, 3.797354031046299, 3.7701245138126604, 3.741819616206161, 3.712359254879291, 3.7107355856968747, 3.682107064367217, 3.65064560111027, 3.6178999488943044, 3.6152622959312497, 3.5844894067183457, 3.5498353957571074, 3.5197890061656247, 3.51391590960226, 3.476840959746793, 3.4384938425996237, 3.4243157163999998, 3.3989405791293694, 3.3581236273849444, 3.328842426634375, 3.315744908212046, 3.2719781005095756, 3.23336913686875, 3.226613459966737, 3.17959928698454, 3.137895847103125, 3.1307963232735547, 3.0800802876976454, 3.0424225573375, 3.0272922794017907, 2.9723998800650824, 2.946949267571875, 2.9148020651002806, 2.8544971883364214, 2.85147597780625, 2.7916530887108935, 2.756002688040625, 2.725347460262892, 2.660529398275, 2.655506259451833, 2.581318796491135, 2.5650561085093746, 2.5027150282198134, 2.4695828187437496, 2.418583035360516, 2.3741095289781247, 2.3282797622072047, 2.2786362392124997, 2.230654267281027, 2.1831629494468747, 2.1242812770998754, 2.0876896596812498, 2.006523084512841, 1.9922163699156248, 1.8967430801499998, 1.8754902776627775, 1.8012697903843748, 1.7250800828925914, 1.7057965006187499, 1.610323210853125, 1.5483169994965416, 1.5148499210875, 1.4193766313218747, 1.3276870861242893, 1.3239033415562498, 1.2284300517906248, 1.1329567620249998, 1.0374834722593749, 1.0053842261147277, 0.9420101824937499, 0.8465368927281248, 0.7510636029624999, 0.6555903131968749, 0.5601170234312498, 0.46464373366562484, 0.36917044389999987, 0.2736971541343749, 0.17822386436874987, 0.08275057460312488, 0.07901441721588644, -0.01272271516250012, -0.10819600492812512, -0.2036692946937501, -0.21210252934277607, -0.29914258445937514, -0.3946158742250001, -0.4076696349248744, -0.4900891639906251, -0.5627267653210066, -0.58556245375625, -0.6810357435218751, -0.6928254243454374, -0.7765090332875001, -0.8071503697280545, -0.8719823230531251, -0.9090761157669188, -0.9674556128187501, -1.0018547983439319, -1.0629289025843751, -1.0872776112938234, -1.15840219235, -1.1663211671404774, -1.240968824047424, -1.253875482115625, -1.3109825458789126, -1.34934877188125, -1.3775294708547887, -1.4407555039389068, -1.444822061646875, -1.501035189120376, -1.5402953514125, -1.5590825485642081, -1.6146936769641678, -1.6357686411781251, -1.668492574331524, -1.7203997295192184, -1.7312419309437501, -1.7707509983615553, -1.8196078420957102, -1.826715220709375, -1.8671603289978431, -1.9134380024287259, -1.922188510475, -1.9586712389247372, -2.0027930942508596, -2.0176618002406252, -2.046107377526424, -2.08836255872808, -2.11313509000625, -2.1299530813638508, -2.1707021233947983, -2.208608379771875, -2.2105962689683554, -2.25029809873717, -2.2892122981408543, -2.3040816695375, -2.3276369246443296, -2.3653521252963734, -2.399554959303125, -2.4024475027186143, -2.4397288168005336, -2.476677057487941, -2.49502824906875, -2.5135010400447437, -2.550314922738148, -2.5871074828928102, -2.590501538834375, -2.6237784633587067, -2.660559941531508, -2.6859748286, -2.6969573305472405, -2.7338530430391574, -2.770651263719013, -2.781448118365625, -2.8070715765368823, -2.8438206922807927, -2.87692140813125, -2.88000251563828, -2.916715131033021, -2.95364808712891, -2.972394697896875, -2.9894245538980426, -3.0260478769645816]
    #image = Image(shot, Rb, Zb)
    return image
end

function Image(EQ::MXHEquilibrium.AbstractEquilibrium)
    _, Sb = MXHEquilibrium.plasma_boundary_psi(EQ; precision=0.0)
    if Sb === nothing
        # if the original boundary specified in EQfixed does not close, then find LCFS boundary
        _, Sb = MXHEquilibrium.plasma_boundary_psi(EQ)
    end
    return Image(EQ, Sb.r, Sb.z)
end

function Image(EQ::MXHEquilibrium.AbstractEquilibrium, Rb::AbstractVector{T}, Zb::AbstractVector{T}) where {T<:Real}
    Lb = cumlength(Rb, Zb)
    # dPsi/dn = σ_RφZ * σ_ρθφ * Bp_fac * R * Bpol
    cocos = MXHEquilibrium.cocos(EQ)
    fac = cocos.sigma_rhotp * cocos.sigma_Bp * (2π)^cocos.exp_Bp
    dψdn_R = zero(Lb)
    dψdn_R .= fac .* MXHEquilibrium.poloidal_Bfield.(Ref(EQ), Rb, Zb)
    return Image(Rb, Zb, Lb, dψdn_R)
end